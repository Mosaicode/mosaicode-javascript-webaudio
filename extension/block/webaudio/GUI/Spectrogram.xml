<?xml version="1.0" encoding="utf-8"?>
<MosaicodeBlock color="150:150:250:150" extension="webaudio" group="GUI" help="Spectrogram" label="Spectrogram" language="javascript" type="mosaicode_lib_javascript_webaudio.extensions.blocks.GUI.spectrogram">
 <onload value="
(function () {
  function SpectrogramVisualizer(audioContext, canvasElement) {
    this.analyserNode = audioContext.createAnalyser();
    this.analyserNode.fftSize = 8192;
    this.fftData = new Float32Array(this.analyserNode.frequencyBinCount);

    this.graphicWidth = parseInt(getComputedStyle(canvasElement).width, 10);
    this.graphicHeight = parseInt(getComputedStyle(canvasElement).height, 10);

    var gc = this.graphicContext = canvasElement.getContext(&quot;2d&quot;);
    gc.fillStyle = '#000000';

    this.pixel = gc.createImageData(1,1);
    this.pixel.data[3] = 255;

    this.gain = 0;
    this.stopping = false;

    this.draw();
  }

  SpectrogramVisualizer.prototype.acceptConnection = function (connectedNode) {
    connectedNode.connect(this.analyserNode);
    this.connectedNode = connectedNode;
  };

  SpectrogramVisualizer.prototype.draw = function () {
    if (this.stopping) {
      this.stopping = false;
      return;
    }

    var gc = this.graphicContext;
    var gw = this.graphicWidth;
    var gh = this.graphicHeight;

    if (!this.connectedNode) {
      gc.fillRect(0, 0, gw, gh);
    }
    else {
      var slideImage = gc.getImageData(0, 0, gw - 1, gh);
      gc.putImageData(slideImage, 1, 0);

      var i, y, n;

      this.analyserNode.getFloatFrequencyData(this.fftData);

      for (i = 0; i &lt; gh; ++i) {
        n = Math.min(Math.max((this.fftData[i] + this.gain + 80) * 4, 0), 255);
        this.pixel.data[0] = n;
        this.pixel.data[1] = n;
        this.pixel.data[2] = n;
        gc.putImageData(this.pixel, 0, gh - i);
      }
    }

    this.animationHandle = requestAnimationFrame(function () { this.draw(); }.bind(this));
  };

  SpectrogramVisualizer.prototype.releaseConnection = function () {
    this.connectedNode.disconnect(this.analyserNode);
    delete this.connectedNode;
  };

  SpectrogramVisualizer.prototype.stop = function () {
    this.stopping = true;
  };

  window.App = window.App || {};
  window.App.SpectrogramVisualizer = SpectrogramVisualizer;
})();

(function () {
    var visCanvas_$id$ = document.getElementById('spectrogram_$id$')
    var visualizer_$id$ = new  App.SpectrogramVisualizer(context, visCanvas_$id$);
    visualizer_$id$.gain = 1;
    visualizer_$id$.acceptConnection(block_$id$);
})();
"/>
 <html value='
&lt;h2&gt;SpectrogramVisualizer_Block$id$&lt;/h2&gt;
&lt;div&gt;
  &lt;canvas id="spectrogram_$id$" width="1024" height="300"&gt;&lt;/canvas&gt;
&lt;/div&gt;

'/>
 <declaration value="
var block_$id$ = context.createGain();
block_$id$.gain = 1;
var $port[input]$ = block_$id$;
"/>
 <properties/>
 <ports>
  <port conn_type="input" label="Input" name_="input" type_="mosaicode_lib_javascript_webaudio.extensions.ports.sound"/>
 </ports>
</MosaicodeBlock>